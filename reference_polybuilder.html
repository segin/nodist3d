<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PolyBuilder 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1a1a1a;
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
        outline: none;
      }

      /* UI Overlays */
      #toolbar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(30, 30, 30, 0.9);
        padding: 8px 16px;
        border-radius: 12px;
        display: flex;
        gap: 12px;
        border: 1px solid #444;
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        z-index: 10;
      }

      #sidebar {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 260px;
        background: rgba(30, 30, 30, 0.9);
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #444;
        display: flex;
        flex-direction: column;
        gap: 12px;
        backdrop-filter: blur(5px);
        z-index: 10;
        transition: transform 0.3s ease;
      }

      #bottom-bar {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(30, 30, 30, 0.8);
        padding: 8px;
        border-radius: 8px;
        font-size: 12px;
        color: #aaa;
        pointer-events: none;
        user-select: none;
      }

      /* Interactive Elements */
      .tool-btn {
        background: #333;
        border: 1px solid #555;
        color: #eee;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
      }

      .tool-btn:hover {
        background: #444;
        border-color: #777;
      }
      .tool-btn.active {
        background: #3b82f6;
        border-color: #2563eb;
        color: white;
      }
      .tool-btn svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
      }

      .group-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #888;
        margin-bottom: 4px;
      }

      input[type='color'] {
        border: none;
        width: 100%;
        height: 32px;
        cursor: pointer;
        background: none;
      }

      input[type='range'] {
        width: 100%;
      }

      /* Fullscreen SVG specific styling */
      .fs-icon path {
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      /* Loading Overlay */
      #loader {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        transition: opacity 0.5s;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #333;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        opacity: 0;
        pointer-events: none;
      }
    </style>
    <!-- Import Maps for Three.js ES Modules -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <!-- Loading Screen -->
    <div id="loader"><div class="spinner"></div></div>

    <!-- Hidden File Input for Imports -->
    <input type="file" id="fileInput" accept=".obj,.glb,.gltf" style="display: none" />

    <!-- Top Toolbar (Transformations & Main Actions) -->
    <div id="toolbar">
      <button class="tool-btn active" id="btn-translate" title="Translate (T)">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 2L12 22M2 12L22 12M12 2L15 5M12 2L9 5M22 12L19 9M22 12L19 15"
            stroke="currentColor"
            stroke-width="2"
          />
        </svg>
      </button>
      <button class="tool-btn" id="btn-rotate" title="Rotate (R)">
        <svg viewBox="0 0 24 24">
          <path
            d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          />
          <path d="M3 3v5h5" fill="none" stroke="currentColor" stroke-width="2" />
        </svg>
      </button>
      <button class="tool-btn" id="btn-scale" title="Scale (S)">
        <svg viewBox="0 0 24 24">
          <rect
            x="4"
            y="4"
            width="16"
            height="16"
            stroke="currentColor"
            fill="none"
            stroke-width="2"
          />
          <path d="M16 16L22 22M2 2L8 8" stroke="currentColor" stroke-width="2" />
        </svg>
      </button>
      <div class="w-px bg-gray-600 mx-2"></div>
      <button
        class="tool-btn text-red-400 hover:bg-red-900 hover:border-red-700"
        id="btn-delete"
        title="Delete Selected (Del)"
      >
        <svg viewBox="0 0 24 24">
          <path
            d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          />
        </svg>
      </button>
      <button class="tool-btn" id="btn-fullscreen" title="Toggle Fullscreen">
        <!-- Specifically requested SVG icon: Four corners of a square -->
        <svg class="fs-icon" viewBox="0 0 24 24">
          <path d="M4 9V5h5M15 4h5v5M20 15v5h-5M9 20H5v-5" />
        </svg>
      </button>
    </div>

    <!-- Right Sidebar (Add Objects & Properties) -->
    <div id="sidebar">
      <div>
        <div class="group-label">Add Primitives</div>
        <div class="grid grid-cols-3 gap-2">
          <button class="tool-btn" onclick="app.addCube()">Cube</button>
          <button class="tool-btn" onclick="app.addSphere()">Sphere</button>
          <button class="tool-btn" onclick="app.addPlane()">Plane</button>
          <button class="tool-btn" onclick="app.addCylinder()">Cyl</button>
          <button class="tool-btn" onclick="app.addTorus()">Torus</button>
          <button class="tool-btn" onclick="app.addIcosahedron()">Ico</button>
        </div>
      </div>

      <div>
        <div class="group-label">File</div>
        <div class="grid grid-cols-2 gap-2">
          <button class="tool-btn" onclick="document.getElementById('fileInput').click()">
            Import Mesh
          </button>
          <button class="tool-btn" onclick="app.clearScene()">Clear All</button>
        </div>
      </div>

      <hr class="border-gray-600 my-2" />

      <div id="properties-panel" class="opacity-50 pointer-events-none transition-opacity">
        <div class="group-label">Properties</div>
        <div class="flex flex-col gap-3">
          <div class="flex items-center gap-2">
            <span class="text-sm w-16">Color</span>
            <input type="color" id="prop-color" value="#ffffff" />
          </div>
          <div class="flex items-center gap-2">
            <span class="text-sm w-16">Wireframe</span>
            <input type="checkbox" id="prop-wireframe" class="w-4 h-4 accent-blue-500" />
          </div>
          <div>
            <span class="text-sm block mb-1">Opacity</span>
            <input type="range" id="prop-opacity" min="0" max="1" step="0.1" value="1" />
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Info -->
    <div id="bottom-bar">
      Left Click: Select | Right Click: Pan | Scroll: Zoom | WASD keys not supported, use Mouse.
    </div>

    <!-- 3D Application Logic -->
    <script type="module">
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      import { TransformControls } from 'three/addons/controls/TransformControls.js';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
      import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

      class EditorApp {
        constructor() {
          this.container = document.body;
          this.objects = []; // Interactive objects
          this.selectedObject = null;

          this.init();
          this.createScene();
          this.setupLights();
          this.setupControls();
          this.setupEvents();
          this.animate();

          // Remove loader
          setTimeout(() => {
            document.getElementById('loader').classList.add('hidden');
          }, 500);
        }

        init() {
          // Renderer
          this.renderer = new THREE.WebGLRenderer({ antialias: true });
          this.renderer.setPixelRatio(window.devicePixelRatio);
          this.renderer.setSize(window.innerWidth, window.innerHeight);
          this.renderer.shadowMap.enabled = true;
          this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
          this.container.appendChild(this.renderer.domElement);

          // Scene
          this.scene = new THREE.Scene();
          this.scene.background = new THREE.Color(0x1a1a1a);

          // Fog for depth
          this.scene.fog = new THREE.Fog(0x1a1a1a, 20, 100);

          // Camera
          this.camera = new THREE.PerspectiveCamera(
            45,
            window.innerWidth / window.innerHeight,
            0.1,
            1000,
          );
          this.camera.position.set(8, 5, 8);
          this.camera.lookAt(0, 0, 0);

          // Raycaster
          this.raycaster = new THREE.Raycaster();
          this.pointer = new THREE.Vector2();
        }

        createScene() {
          // Grid
          const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
          this.scene.add(gridHelper);

          // Axes
          const axesHelper = new THREE.AxesHelper(2);
          this.scene.add(axesHelper);

          // Floor (Invisible plane for raycasting if needed, but grid is usually enough visually)
          const planeGeometry = new THREE.PlaneGeometry(20, 20);
          const planeMaterial = new THREE.MeshBasicMaterial({ visible: false });
          const plane = new THREE.Mesh(planeGeometry, planeMaterial);
          plane.rotation.x = -Math.PI / 2;
          this.scene.add(plane);
        }

        setupLights() {
          const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
          this.scene.add(ambientLight);

          const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
          dirLight.position.set(5, 10, 7);
          dirLight.castShadow = true;
          dirLight.shadow.mapSize.width = 1024;
          dirLight.shadow.mapSize.height = 1024;
          this.scene.add(dirLight);
        }

        setupControls() {
          // Orbit Controls (Camera movement)
          this.orbit = new OrbitControls(this.camera, this.renderer.domElement);
          this.orbit.enableDamping = true;
          this.orbit.dampingFactor = 0.05;

          // Transform Controls (Object manipulation)
          this.transformControl = new TransformControls(this.camera, this.renderer.domElement);

          // Disable orbit when dragging an object
          this.transformControl.addEventListener('dragging-changed', (event) => {
            this.orbit.enabled = !event.value;
          });

          this.transformControl.addEventListener('change', () => {
            // Update UI values if transformed (optional extension)
          });

          this.scene.add(this.transformControl);
        }

        // --- Object Creation ---

        createMesh(geometry, name) {
          const material = new THREE.MeshStandardMaterial({
            color: Math.random() * 0xffffff,
            roughness: 0.2,
            metalness: 0.1,
          });
          const mesh = new THREE.Mesh(geometry, material);
          mesh.castShadow = true;
          mesh.receiveShadow = true;
          mesh.position.y = 1; // Sit on grid
          mesh.name = name || 'Object';

          this.scene.add(mesh);
          this.objects.push(mesh);
          this.selectObject(mesh);
          return mesh;
        }

        addCube() {
          this.createMesh(new THREE.BoxGeometry(1, 1, 1), 'Cube');
        }
        addSphere() {
          this.createMesh(new THREE.SphereGeometry(0.6, 32, 16), 'Sphere');
        }
        addPlane() {
          const mesh = this.createMesh(new THREE.PlaneGeometry(2, 2), 'Plane');
          mesh.rotation.x = -Math.PI / 2;
          mesh.position.y = 0.01;
          mesh.material.side = THREE.DoubleSide;
        }
        addCylinder() {
          this.createMesh(new THREE.CylinderGeometry(0.5, 0.5, 1, 32), 'Cylinder');
        }
        addTorus() {
          this.createMesh(new THREE.TorusGeometry(0.5, 0.2, 16, 50), 'Torus');
        }
        addIcosahedron() {
          this.createMesh(new THREE.IcosahedronGeometry(0.6, 0), 'Icosahedron');
        }

        // --- Selection Logic ---

        selectObject(object) {
          this.selectedObject = object;

          if (object) {
            this.transformControl.attach(object);
            this.updateUIProperties(object);
            document
              .getElementById('properties-panel')
              .classList.remove('opacity-50', 'pointer-events-none');
          } else {
            this.transformControl.detach();
            document
              .getElementById('properties-panel')
              .classList.add('opacity-50', 'pointer-events-none');
          }
        }

        deleteSelected() {
          if (!this.selectedObject) return;

          this.scene.remove(this.selectedObject);
          this.transformControl.detach();

          // Remove from objects array
          this.objects = this.objects.filter((obj) => obj !== this.selectedObject);

          // Dispose geometry/material
          if (this.selectedObject.geometry) this.selectedObject.geometry.dispose();
          if (this.selectedObject.material) this.selectedObject.material.dispose();

          this.selectedObject = null;
          document
            .getElementById('properties-panel')
            .classList.add('opacity-50', 'pointer-events-none');
        }

        clearScene() {
          // Remove all interactable objects
          [...this.objects].forEach((obj) => {
            this.scene.remove(obj);
            if (obj.geometry) obj.geometry.dispose();
            if (obj.material) obj.material.dispose();
          });
          this.objects = [];
          this.selectObject(null);
        }

        // --- Import Logic ---

        handleFileImport(file) {
          const url = URL.createObjectURL(file);
          const ext = file.name.split('.').pop().toLowerCase();

          const onLoad = (object) => {
            // Normalize size
            const box = new THREE.Box3().setFromObject(object);
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 2 / maxDim;
            object.scale.setScalar(scale);

            object.position.y = (size.y * scale) / 2; // Sit on floor

            // Traverse to fix materials and shadows
            object.traverse((child) => {
              if (child.isMesh) {
                child.castShadow = true;
                child.receiveShadow = true;
                // Ensure standard material for lighting interactions
                if (!(child.material instanceof THREE.MeshStandardMaterial)) {
                  child.material = new THREE.MeshStandardMaterial({
                    color: child.material.color || 0xffffff,
                    map: child.material.map || null,
                  });
                }
              }
            });

            this.scene.add(object);
            this.objects.push(object);
            this.selectObject(object);
            URL.revokeObjectURL(url);
          };

          const onError = (e) => console.error(e);

          if (ext === 'obj') {
            new OBJLoader().load(url, onLoad, undefined, onError);
          } else if (ext === 'glb' || ext === 'gltf') {
            new GLTFLoader().load(url, (gltf) => onLoad(gltf.scene), undefined, onError);
          } else {
            alert('Unsupported file format. Please use .obj, .glb, or .gltf');
          }
        }

        // --- UI & Events ---

        updateUIProperties(mesh) {
          if (!mesh || !mesh.material) return;
          const mat = mesh.material;
          const colorInput = document.getElementById('prop-color');
          const wireInput = document.getElementById('prop-wireframe');
          const opacityInput = document.getElementById('prop-opacity');

          colorInput.value = '#' + mat.color.getHexString();
          wireInput.checked = mat.wireframe;
          opacityInput.value = mat.opacity;
        }

        setupEvents() {
          // Window Resize
          window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth / window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
          });

          // Mouse Click (Selection)
          window.addEventListener('pointerdown', (event) => {
            // Only process click if not on UI
            if (event.target.closest('#toolbar') || event.target.closest('#sidebar')) return;

            // Calculate mouse pos
            this.pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            this.pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

            this.raycaster.setFromCamera(this.pointer, this.camera);
            const intersects = this.raycaster.intersectObjects(this.objects, true);

            if (intersects.length > 0) {
              // Find the root mesh if we hit a child part of an imported model
              let target = intersects[0].object;
              while (target.parent && !this.objects.includes(target)) {
                target = target.parent;
              }
              this.selectObject(target);
            } else {
              // Deselect if clicking empty space (and not transforming)
              if (!this.transformControl.dragging) {
                this.selectObject(null);
              }
            }
          });

          // Transform Modes
          document
            .getElementById('btn-translate')
            .addEventListener('click', (e) => this.setMode('translate', e.currentTarget));
          document
            .getElementById('btn-rotate')
            .addEventListener('click', (e) => this.setMode('rotate', e.currentTarget));
          document
            .getElementById('btn-scale')
            .addEventListener('click', (e) => this.setMode('scale', e.currentTarget));

          // Delete
          document
            .getElementById('btn-delete')
            .addEventListener('click', () => this.deleteSelected());

          // Fullscreen
          document.getElementById('btn-fullscreen').addEventListener('click', () => {
            if (!document.fullscreenElement) {
              document.body.requestFullscreen().catch((err) => {
                alert(`Error attempting to enable fullscreen: ${err.message}`);
              });
            } else {
              document.exitFullscreen();
            }
          });

          // Keybindings
          window.addEventListener('keydown', (event) => {
            switch (event.key.toLowerCase()) {
              case 't':
                this.setMode('translate', document.getElementById('btn-translate'));
                break;
              case 'r':
                this.setMode('rotate', document.getElementById('btn-rotate'));
                break;
              case 's':
                this.setMode('scale', document.getElementById('btn-scale'));
                break;
              case 'delete':
              case 'backspace':
                this.deleteSelected();
                break;
            }
          });

          // Property Changes
          document.getElementById('prop-color').addEventListener('input', (e) => {
            if (this.selectedObject && this.selectedObject.material) {
              this.selectedObject.material.color.set(e.target.value);
            }
            // Handle Group/Imported objects recursively
            if (this.selectedObject) {
              this.selectedObject.traverse((child) => {
                if (child.isMesh) child.material.color.set(e.target.value);
              });
            }
          });

          document.getElementById('prop-wireframe').addEventListener('change', (e) => {
            if (this.selectedObject) {
              this.selectedObject.traverse((child) => {
                if (child.isMesh) child.material.wireframe = e.target.checked;
              });
            }
          });

          document.getElementById('prop-opacity').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (this.selectedObject) {
              this.selectedObject.traverse((child) => {
                if (child.isMesh) {
                  child.material.transparent = val < 1;
                  child.material.opacity = val;
                }
              });
            }
          });

          // Import
          document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
              this.handleFileImport(e.target.files[0]);
              e.target.value = ''; // Reset
            }
          });
        }

        setMode(mode, btnElement) {
          this.transformControl.setMode(mode);
          // Update UI buttons
          document
            .querySelectorAll('#toolbar .tool-btn')
            .forEach((b) => b.classList.remove('active'));
          if (btnElement) btnElement.classList.add('active');
        }

        animate() {
          requestAnimationFrame(() => this.animate());
          this.orbit.update();
          this.renderer.render(this.scene, this.camera);
        }
      }

      // Initialize App
      window.app = new EditorApp();
    </script>
  </body>
</html>
